((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=Array.prototype.slice,z=function(a,b){return function(){return a.apply(b,arguments)}},A=Object.prototype.hasOwnProperty;window.sharejs=m={version:"0.5.0-pre"},s=function(a){return setTimeout(a,0)},e=function(){function a(){}return a.prototype.on=function(a,b){var c;return this._events||(this._events={}),(c=this._events)[a]||(c[a]=[]),this._events[a].push(b),this},a.prototype.removeListener=function(a,b){var c,d,e,f=this;this._events||(this._events={}),d=(e=this._events)[a]||(e[a]=[]),c=0;while(c<d.length)d[c]===b&&(d[c]=void 0),c++;return s(function(){var b;return f._events[a]=function(){var c,d,e=this._events[a],f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b&&f.push(b);return f}.call(f)}),this},a.prototype.emit=function(){var a,b,c,d,e,f=arguments[0],g=2<=arguments.length?y.call(arguments,1):[];if((d=this._events)!=null?!d[f]:!void 0)return this;e=this._events[f];for(b=0,c=e.length;b<c;b++)a=e[b],a&&a.apply(this,g);return this},a}(),e.mixin=function(a){var b=a.prototype||a;return b.on=e.prototype.on,b.removeListener=e.prototype.removeListener,b.emit=e.prototype.emit,a},m._bt=h=function(a,b,c,d){var e,f=function(a,c,d,e){return b(d,a,c,"left"),b(e,c,a,"right")};return a.transformX=a.transformX=e=function(a,b){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;c(a),c(b),k=[];for(p=0,t=b.length;p<t;p++){o=b[p],j=[],g=0;while(g<a.length){l=[],f(a[g],o,j,l),g++;if(l.length!==1){if(l.length===0){x=a.slice(g);for(q=0,u=x.length;q<u;q++)h=x[q],d(j,h);o=null;break}y=e(a.slice(g),l),i=y[0],n=y[1];for(r=0,v=i.length;r<v;r++)h=i[r],d(j,h);for(s=0,w=n.length;s<w;s++)m=n[s],d(k,m);o=null;break}o=l[0]}o!=null&&d(k,o),a=j}return[a,k]},a.transform=a.transform=function(a,c,d){var f,g,h,i,j;if(d!=="left"&&d!=="right")throw new Error("type must be 'left' or 'right'");return c.length===0?a:a.length===1&&c.length===1?b([],a[0],c[0],d):d==="left"?(i=e(a,c),f=i[0],h=i[1],f):(j=e(c,a),h=j[0],g=j[1],g)}},u={},u.name="text",u.create=u.create=function(){return""},t=function(a,b,c){return a.slice(0,b)+c+a.slice(b)},j=function(a){var b,c;if(typeof a.p!="number")throw new Error("component missing position field");c=typeof a.i,b=typeof a.d;if(!(c==="string"^b==="string"))throw new Error("component needs an i or d field");if(!(a.p>=0))throw new Error("position cannot be negative")},k=function(a){var b,c,d;for(c=0,d=a.length;c<d;c++)b=a[c],j(b);return!0},u.apply=function(a,b){var c,d,e,f;k(b);for(e=0,f=b.length;e<f;e++){c=b[e];if(c.i!=null)a=t(a,c.p,c.i);else{d=a.slice(c.p,c.p+c.d.length);if(c.d!==d)throw new Error("Delete component '"+c.d+"' does not match deleted text '"+d+"'");a=a.slice(0,c.p)+a.slice(c.p+c.d.length)}}return a},u._append=g=function(a,b){var c,d,e;if(b.i===""||b.d==="")return;return a.length===0?a.push(b):(c=a[a.length-1],c.i!=null&&b.i!=null&&c.p<=(d=b.p)&&d<=c.p+c.i.length?a[a.length-1]={i:t(c.i,b.p-c.p,b.i),p:c.p}:c.d!=null&&b.d!=null&&b.p<=(e=c.p)&&e<=b.p+b.d.length?a[a.length-1]={d:t(b.d,c.p-b.p,c.d),p:b.p}:a.push(b))},u.compose=function(a,b){var c,d,e,f;k(a),k(b),d=a.slice();for(e=0,f=b.length;e<f;e++)c=b[e],g(d,c);return d},u.compress=function(a){return u.compose([],a)},u.normalize=function(a){var b,c,d,e=[];if(a.i!=null||a.p!=null)a=[a];for(c=0,d=a.length;c<d;c++)b=a[c],b.p==null&&(b.p=0),g(e,b);return e},w=function(a,b,c){return b.i!=null?b.p<a||b.p===a&&c?a+b.i.length:a:a<=b.p?a:a<=b.p+b.d.length?b.p:a-b.d.length},u.transformCursor=function(a,b,c){var d,e,f;for(e=0,f=b.length;e<f;e++)d=b[e],a=w(a,d,c);return a},u._tc=v=function(a,b,c,d){var e,f,h,i,j,l;k([b]),k([c]);if(b.i!=null)g(a,{i:b.i,p:w(b.p,c,d==="right")});else if(c.i!=null)l=b.d,b.p<c.p&&(g(a,{d:l.slice(0,c.p-b.p),p:b.p}),l=l.slice(c.p-b.p)),l!==""&&g(a,{d:l,p:b.p+c.i.length});else if(b.p>=c.p+c.d.length)g(a,{d:b.d,p:b.p-c.d.length});else if(b.p+b.d.length<=c.p)g(a,b);else{i={d:"",p:b.p},b.p<c.p&&(i.d=b.d.slice(0,c.p-b.p)),b.p+b.d.length>c.p+c.d.length&&(i.d+=b.d.slice(c.p+c.d.length-b.p)),h=Math.max(b.p,c.p),f=Math.min(b.p+b.d.length,c.p+c.d.length),e=b.d.slice(h-b.p,f-b.p),j=c.d.slice(h-c.p,f-c.p);if(e!==j)throw new Error("Delete ops delete different text in the same region of the document");i.d!==""&&(i.p=w(i.p,c),g(a,i))}return a},o=function(a){return a.i!=null?{d:a.i,p:a.p}:{i:a.d,p:a.p}},u.invert=function(a){var b,c,d,e=a.slice().reverse(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(o(b));return f},m.types||(m.types={}),h(u,v,k,g),m.types.text=u,u.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(a,b,c){var d=[{p:a,i:b}];return this.submitOp(d,c),d},del:function(a,b,c){var d=[{p:a,d:this.snapshot.slice(a,a+b)}];return this.submitOp(d,c),d},_register:function(){return this.on("remoteop",function(a){var b,c,d,e=[];for(c=0,d=a.length;c<d;c++)b=a[c],b.i!==void 0?e.push(this.emit("insert",b.p,b.i)):e.push(this.emit("delete",b.p,b.d));return e})}},u=m.types.text,q={},q.name="json",q.create=function(){return null},q.invertComponent=function(a){var b={p:a.p};return a.si!==void 0&&(b.sd=a.si),a.sd!==void 0&&(b.si=a.sd),a.oi!==void 0&&(b.od=a.oi),a.od!==void 0&&(b.oi=a.od),a.li!==void 0&&(b.ld=a.li),a.ld!==void 0&&(b.li=a.ld),a.na!==void 0&&(b.na=-a.na),a.lm!==void 0&&(b.lm=a.p[a.p.length-1],b.p=a.p.slice(0,a.p.length-1).concat([a.lm])),b},q.invert=function(a){var b,c,d,e=a.slice().reverse(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(q.invertComponent(b));return f},q.checkValidOp=function(){},p=function(a){return Object.prototype.toString.call(a)==="[object Array]"},q.checkList=function(a){if(!p(a))throw new Error("Referenced element not a list")},q.checkObj=function(a){if(a.constructor!==Object)throw new Error("Referenced element not an object (it was "+JSON.stringify(a)+")")},q.apply=function(a,b){var c,d,e,f,g,h,i,j,k,m,n,o,p;q.checkValidOp(b),b=l(b),d={data:l(a)};try{for(g=0,n=b.length;g<n;g++){c=b[g],j=null,k=null,f=d,h="data",p=c.p;for(m=0,o=p.length;m<o;m++){i=p[m],j=f,k=h,f=f[h],h=i;if(j==null)throw new Error("Path invalid")}if(c.na!==void 0){if(typeof f[h]!="number")throw new Error("Referenced element not a number");f[h]+=c.na}else if(c.si!==void 0){if(typeof f!="string")throw new Error("Referenced element not a string (it was "+JSON.stringify(f)+")");j[k]=f.slice(0,h)+c.si+f.slice(h)}else if(c.sd!==void 0){if(typeof f!="string")throw new Error("Referenced element not a string");if(f.slice(h,h+c.sd.length)!==c.sd)throw new Error("Deleted string does not match");j[k]=f.slice(0,h)+f.slice(h+c.sd.length)}else if(c.li!==void 0&&c.ld!==void 0)q.checkList(f),f[h]=c.li;else if(c.li!==void 0)q.checkList(f),f.splice(h,0,c.li);else if(c.ld!==void 0)q.checkList(f),f.splice(h,1);else if(c.lm!==void 0)q.checkList(f),c.lm!==h&&(e=f[h],f.splice(h,1),f.splice(c.lm,0,e));else if(c.oi!==void 0)q.checkObj(f),f[h]=c.oi;else{if(c.od===void 0)throw new Error("invalid / missing instruction in op");q.checkObj(f),delete f[h]}}}catch(r){throw r}return d.data},q.pathMatches=function(a,b,c){var d,e,f;if(a.length!==b.length)return!1;for(d=0,f=a.length;d<f;d++){e=a[d];if(e!==b[d]&&(!c||d!==a.length-1))return!1}return!0},q.append=function(a,b){var c;return b=l(b),a.length!==0&&q.pathMatches(b.p,(c=a[a.length-1]).p)?c.na!==void 0&&b.na!==void 0?a[a.length-1]={p:c.p,na:c.na+b.na}:c.li!==void 0&&b.li===void 0&&b.ld===c.li?c.ld!==void 0?delete c.li:a.pop():c.od!==void 0&&c.oi===void 0&&b.oi!==void 0&&b.od===void 0?c.oi=b.oi:b.lm!==void 0&&b.p[b.p.length-1]===b.lm?null:a.push(b):a.push(b)},q.compose=function(a,b){var c,d,e,f;q.checkValidOp(a),q.checkValidOp(b),d=l(a);for(e=0,f=b.length;e<f;e++)c=b[e],q.append(d,c);return d},q.normalize=function(a){var b,c,d,e=[];p(a)||(a=[a]);for(c=0,d=a.length;c<d;c++)b=a[c],b.p==null&&(b.p=[]),q.append(e,b);return e},l=function(a){return JSON.parse(JSON.stringify(a))},q.commonPath=function(a,b){var c;a=a.slice(),b=b.slice(),a.unshift("data"),b.unshift("data"),a=a.slice(0,a.length-1),b=b.slice(0,b.length-1);if(b.length===0)return-1;c=0;while(a[c]===b[c]&&c<a.length){c++;if(c===b.length)return c-1}},q.transformComponent=function(a,b,c,d){var e,f,g,h,i,j,k,m,n,o,p,r,s,t,v,w,x,y,z;b=l(b),b.na!==void 0&&b.p.push(0),c.na!==void 0&&c.p.push(0),e=q.commonPath(b.p,c.p),f=q.commonPath(c.p,b.p),i=b.p.length,n=c.p.length,b.na!==void 0&&b.p.pop(),c.na!==void 0&&c.p.pop();if(c.na)return f!=null&&n>=i&&c.p[f]===b.p[f]&&(b.ld!==void 0?(m=l(c),m.p=m.p.slice(i),b.ld=q.apply(l(b.ld),[m])):b.od!==void 0&&(m=l(c),m.p=m.p.slice(i),b.od=q.apply(l(b.od),[m]))),q.append(a,b),a;f!=null&&n>i&&b.p[f]===c.p[f]&&(b.ld!==void 0?(m=l(c),m.p=m.p.slice(i),b.ld=q.apply(l(b.ld),[m])):b.od!==void 0&&(m=l(c),m.p=m.p.slice(i),b.od=q.apply(l(b.od),[m])));if(e!=null){g=i===n;if(c.na===void 0)if(c.si!==void 0||c.sd!==void 0){if(b.si!==void 0||b.sd!==void 0){if(!g)throw new Error("must be a string?");h=function(a){var b={p:a.p[a.p.length-1]};return a.si?b.i=a.si:b.d=a.sd,b},v=h(b),w=h(c),s=[],u._tc(s,v,w,d);for(y=0,z=s.length;y<z;y++)t=s[y],k={p:b.p.slice(0,e)},k.p.push(t.p),t.i!=null&&(k.si=t.i),t.d!=null&&(k.sd=t.d),q.append(a,k);return a}}else if(c.li!==void 0&&c.ld!==void 0){if(c.p[e]===b.p[e]){if(!g)return a;if(b.ld!==void 0){if(b.li===void 0||d!=="left")return a;b.ld=l(c.li)}}}else if(c.li!==void 0)b.li!==void 0&&b.ld===void 0&&g&&b.p[e]===c.p[e]?d==="right"&&b.p[e]++:c.p[e]<=b.p[e]&&b.p[e]++,b.lm!==void 0&&g&&c.p[e]<=b.lm&&b.lm++;else if(c.ld!==void 0){if(b.lm!==void 0&&g){if(c.p[e]===b.p[e])return a;r=c.p[e],j=b.p[e],x=b.lm,(r<x||r===x&&j<x)&&b.lm--}if(c.p[e]<b.p[e])b.p[e]--;else if(c.p[e]===b.p[e]){if(n<i)return a;if(b.ld!==void 0){if(b.li===void 0)return a;delete b.ld}}}else if(c.lm!==void 0)if(b.lm!==void 0&&i===n){j=b.p[e],x=b.lm,o=c.p[e],p=c.lm;if(o!==p)if(j===o){if(d!=="left")return a;b.p[e]=p,j===x&&(b.lm=p)}else j>o&&b.p[e]--,j>p?b.p[e]++:j===p&&o>p&&(b.p[e]++,j===x&&b.lm++),x>o?b.lm--:x===o&&x>j&&b.lm--,x>p?b.lm++:x===p&&(p>o&&x>j||p<o&&x<j?d==="right"&&b.lm++:x>j?b.lm++:x===o&&b.lm--)}else b.li!==void 0&&b.ld===void 0&&g?(j=c.p[e],x=c.lm,r=b.p[e],r>j&&b.p[e]--,r>x&&b.p[e]++):(j=c.p[e],x=c.lm,r=b.p[e],r===j?b.p[e]=x:(r>j&&b.p[e]--,r>x?b.p[e]++:r===x&&j>x&&b.p[e]++));else if(c.oi!==void 0&&c.od!==void 0){if(b.p[e]===c.p[e]){if(b.oi===void 0||!g)return a;if(d==="right")return a;b.od=c.oi}}else if(c.oi!==void 0){if(b.oi!==void 0&&b.p[e]===c.p[e]){if(d!=="left")return a;q.append(a,{p:b.p,od:c.oi})}}else if(c.od!==void 0&&b.p[e]===c.p[e]){if(!g)return a;if(b.oi===void 0)return a;delete b.od}}return q.append(a,b),a},m.types||(m.types={}),m._bt(q,q.transformComponent,q.checkValidOp,q.append),m.types.json=q,l=function(a){return JSON.parse(JSON.stringify(a))},d=function(){function a(){this.transformOp=z(this.transformOp,this),this._transformParamsdAgainstParamsd=z(this._transformParamsdAgainstParamsd,this),this._transformParamsiAgainstParamsi=z(this._transformParamsiAgainstParamsi,this),this._transformParamsChangeAgainstParamsChange=z(this._transformParamsChangeAgainstParamsChange,this),this._revertParamsChange=z(this._revertParamsChange,this),this._transformParamsdAgainstParamsi=z(this._transformParamsdAgainstParamsi,this),this._transformParamsiAgainstParamsd=z(this._transformParamsiAgainstParamsd,this),this._transformParamsdAgainstTd=z(this._transformParamsdAgainstTd,this),this._transformParamsiAgainstTd=z(this._transformParamsiAgainstTd,this),this._transformTdAgainstParamsd=z(this._transformTdAgainstParamsd,this),this._transformTdAgainstParamsi=z(this._transformTdAgainstParamsi,this),this._transformParamsdAgainstTi=z(this._transformParamsdAgainstTi,this),this._transformParamsiAgainstTi=z(this._transformParamsiAgainstTi,this),this._transformTiAgainstParamsd=z(this._transformTiAgainstParamsd,this),this._transformTiAgainstParamsi=z(this._transformTiAgainstParamsi,this),this._transformParamsChangeAgainstTd=z(this._transformParamsChangeAgainstTd,this),this._transformTdAgainstParamsChange=z(this._transformTdAgainstParamsChange,this),this._transformParamsChangeAgainstTi=z(this._transformParamsChangeAgainstTi,this),this._transformTiAgainstParamsChange=z(this._transformTiAgainstParamsChange,this),this._transformTdAgainstTd=z(this._transformTdAgainstTd,this),this._transformTdAgainstTi=z(this._transformTdAgainstTi,this),this._transformTiAgainstTd=z(this._transformTiAgainstTd,this),this._transformTiAgainstTi=z(this._transformTiAgainstTi,this),this._changeParams=z(this._changeParams,this),this._applyParamsInsert=z(this._applyParamsInsert,this),this._applyParamsDelete=z(this._applyParamsDelete,this),this._applyTextDelete=z(this._applyTextDelete,this),this._applyTextInsert=z(this._applyTextInsert,this)}return a.prototype._getBlockAndOffset=function(a,b){var c,d,e,f=0;for(d=0,e=a.length;d<e;d++){c=a[d];if(f+c.t.length>b)return[d,b-f];f+=c.t.length}if(b>f)throw new Error("Specified position ("+b+") is more then text length ("+f+")");return[a.length,b-f]},a.prototype._checkParams=function(a){var b,c,d;if(!a instanceof Object)throw new Error("Params should be an object");d=[];for(c in a){b=a[c];if(b instanceof Object)throw new Error("Non-scalar types are not allowed in params");d.push(void 0)}return d},a.prototype._paramsAreEqual=function(a,b){var c=function(a,b){var c;for(c in a){if(!(c in b))return!1;if(a[c]!==b[c])return!1}return!0};return c(a,b)?c(b,a)?!0:!1:!1},a.prototype._splitBlock=function(a,b){var c;return b===0?[a]:(c=l(a),a.t=a.t.substr(0,b),c.t=c.t.substr(b),[a,c])},a.prototype._tryMerge=function(a,b,c){var d,e,f,g,h,i;b=Math.max(b,0),c=Math.min(c,a.length-1),e=c-1,i=[];while(e>=b)d=a[e],f=a[e+1],this._paramsAreEqual(d.params,f.params)&&([].splice.apply(a,[g=e+1,e+1-g+1].concat(h=[])),h,d.t+=f.t),i.push(e--);return i},a.prototype._applyTextInsert=function(a,b){var c,d,e,f,g,h,i;return this._checkParams(b.params),h=this._getBlockAndOffset(a,b.p),d=h[0],g=h[1],a.length===d?(a.push({t:b.ti,params:l(b.params)}),this._tryMerge(a,d-1,d),a):(c=a[d],this._paramsAreEqual(c.params,b.params)?c.t=c.t.substr(0,g)+b.ti+c.t.substr(g):(e=this._splitBlock(c,g),f={t:b.ti,params:l(b.params)},[].splice.apply(e,[i=e.length-1,e.length-1-i].concat(f)),f,[].splice.apply(a,[d,d-d+1].concat(e)),e,this._tryMerge(a,d-1,d)),a)},a.prototype._applyTextDelete=function(a,b){var c,d,e=this._getBlockAndOffset(a,b.p),f=e[0],g=e[1],h=a[f];if(!this._paramsAreEqual(h.params,b.params))throw new Error("Text block params ("+JSON.stringify(h.params)+") do not equal to op params ("+JSON.stringify(b.params)+")");c=h.t.substr(g,b.td.length);if(c!==b.td)throw new Error("Deleted text ("+c+") is not equal to text in operation ("+b.td+")");return h.t=h.t.substr(0,g)+h.t.substr(g+b.td.length),h.t||([].splice.apply(a,[f,f-f+1].concat(d=[])),d,this._tryMerge(a,f-1,f)),a},a.prototype._getFirstParam=function(a){var b,c;for(b in a)return c=a[b],[b,c]},a.prototype._hasOneParam=function(a){var b,c=!1;for(b in a){if(!A.call(a,b))continue;if(c)return!1;c=!0}return c},a.prototype._deleteParams=function(a,b){var c=this._getFirstParam(b),d=c[0],e=c[1];if(a[d]!==e)throw new Error("Params delete tried to remove param "+d+" with value "+e+" from "+JSON.stringify(a)+", but it does not match");return delete a[d]},a.prototype._applyParamsDelete=function(a,b){var c,d=this;if(!this._hasOneParam(b.paramsd))throw new Error("Exactly one param should be deleted: "+JSON.stringify(b));return c=function(a){return d._deleteParams(a.params,b.paramsd)},this._changeParams(a,b.p,b.len,c)},a.prototype._insertParams=function(a,b){var c=this._getFirstParam(b),d=c[0],e=c[1];if(a[d]!=null)throw new Error("Params insert tried to set param "+d+" with value "+e+" to block "+JSON.stringify(a)+", but it is already set");return a[d]=e},a.prototype._applyParamsInsert=function(a,b){var c,d=this;this._checkParams(b.paramsi);if(!this._hasOneParam(b.paramsi))throw new Error("Exactly one param should be inserted: "+JSON.stringify(b));return c=function(a){return d._insertParams(a.params,b.paramsi)},this._changeParams(a,b.p,b.len,c)},a.prototype._changeParams=function(a,b,c,d){var e,f,g,h=this._getBlockAndOffset(a,b),i=h[0],j=h[1],k=this._getBlockAndOffset(a,b+c),l=k[0],m=k[1];m===0?l--:([].splice.apply(a,[l,l-l+1].concat(f=this._splitBlock(a[l],m))),f),j>0&&([].splice.apply(a,[i,i-i+1].concat(g=this._splitBlock(a[i],j))),g,i++,l++);for(e=i;i<=l?e<=l:e>=l;i<=l?e++:e--)d(a[e]);return this._tryMerge(a,i-1,l+1),a},a.prototype._transformPosAgainstInsert=function(a,b,c,d){return b>a?a:b===a&&!d?a:a+c},a.prototype._transformPosAgainstDelete=function(a,b,c){return a>b+c?a-c:a>b?b:a},a.prototype._transformTiAgainstTi=function(a,b,c,d){var e;return b=l(b),b.shiftLeft===c.shiftLeft?e=d==="right":e=c.shiftLeft,b.p=this._transformPosAgainstInsert(b.p,c.p,c.ti.length,e),a.push(b),a},a.prototype._transformTiAgainstTd=function(a,b,c){return b=l(b),b.p=this._transformPosAgainstDelete(b.p,c.p,c.td.length),a.push(b),a},a.prototype._transformTdAgainstTi=function(a,b,c){var d=b.td;return b.p<c.p&&(a.push({p:b.p,td:d.slice(0,c.p-b.p),params:l(b.params)}),d=d.slice(c.p-b.p)),d&&a.push({p:b.p+c.ti.length,td:d,params:l(b.params)}),a},a.prototype._transformTdAgainstTd=function(a,b,c){var d,e,f,g,h;if(b.p>=c.p+c.td.length)a.push({p:b.p-c.td.length,td:b.td,params:l(b.params)});else if(b.p+b.td.length<=c.p)a.push(l(b));else{if(!this._paramsAreEqual(b.params,c.params))throw new Error("Two text delete operations overlap but have different params: "+JSON.stringify(b)+", "+JSON.stringify(c));e=Math.max(b.p,c.p),d=Math.min(b.p+b.td.length,c.p+c.td.length),g=b.td.slice(e-b.p,d-b.p),h=c.td.slice(e-c.p,d-c.p);if(g!==h)throw new Error("Delete ops delete different text in the same region of the document: "+JSON.stringify(b)+", "+JSON.stringify(c));f={td:"",p:b.p,params:l(b.params)},b.p<c.p&&(f.td=b.td.slice(0,c.p-b.p)),b.p+b.td.length>c.p+c.td.length&&(f.td+=b.td.slice(c.p+c.td.length-b.p)),f.td&&(f.p=this._transformPosAgainstDelete(f.p,c.p,c.td.length),a.push(f))}return a},a.prototype._transformTiAgainstParamsChange=function(a,b){return a.push(l(b)),a},a.prototype._transformParamsChangeAgainstTi=function(a,b,c){var d,e,f=b.len;return b.p<c.p&&(d=Math.min(f,c.p-b.p),e=l(b),e.len=d,a.push(e),f-=d),f&&(e=l(b),e.p=Math.max(c.p,b.p)+c.ti.length,e.len=f,a.push(e)),a},a.prototype._transformTdAgainstParamsChange=function(a,b,c,d){var e,f,g;return b.p>=c.p+c.len||b.p+b.td.length<=c.p?(a.push(l(b)),a):(g=b.td,b.p<c.p&&(f=l(b),f.td=g.slice(0,c.p-b.p),a.push(f),g=g.slice(c.p-b.p)),f=l(b),e=c.p+c.len-Math.max(c.p,b.p),f.td=g.slice(0,e),d(f.params,c),g=g.slice(e),a.push(f),g&&(f=l(b),f.td=g,a.push(f)),a)},a.prototype._transformParamsChangeAgainstTd=function(a,b,c){var d;return b.p>=c.p+c.td.length?(d=l(b),d.p-=c.td.length,a.push(d)):b.p+b.len<=c.p?a.push(l(b)):(d=l(b),d.len=0,b.p<c.p&&(d.len=Math.min(b.len,c.p-b.p)),b.p+b.len>c.p+c.td.length&&(d.len+=b.p+b.len-(c.p+c.td.length)),d.len&&(d.p=this._transformPosAgainstDelete(d.p,c.p,c.td.length),a.push(d))),a},a.prototype._transformTiAgainstParamsi=function(){var a=1<=arguments.length?y.call(arguments,0):[];return this._transformTiAgainstParamsChange.apply(this,a)},a.prototype._transformTiAgainstParamsd=function(){var a=1<=arguments.length?y.call(arguments,0):[];return this._transformTiAgainstParamsChange.apply(this,a)},a.prototype._transformParamsiAgainstTi=function(){var a=1<=arguments.length?y.call(arguments,0):[];return this._transformParamsChangeAgainstTi.apply(this,a)},a.prototype._transformParamsdAgainstTi=function(){var a=1<=arguments.length?y.call(arguments,0):[];return this._transformParamsChangeAgainstTi.apply(this,a)},a.prototype._transformTdAgainstParamsi=function(a,b,c){var d=this;return this._transformTdAgainstParamsChange(a,b,c,function(a,b){return d._insertParams(a,b.paramsi)})},a.prototype._transformTdAgainstParamsd=function(a,b,c){var d=this;return this._transformTdAgainstParamsChange(a,b,c,function(a,b){return d._deleteParams(a,b.paramsd)})},a.prototype._transformParamsiAgainstTd=function(){var a=1<=arguments.length?y.call(arguments,0):[];return this._transformParamsChangeAgainstTd.apply(this,a)},a.prototype._transformParamsdAgainstTd=function(){var a=1<=arguments.length?y.call(arguments,0):[];return this._transformParamsChangeAgainstTd.apply(this,a)},a.prototype._transformParamsiAgainstParamsd=function(a,b){return a.push(l(b)),a},a.prototype._transformParamsdAgainstParamsi=function(a,b){return a.push(l(b)),a},a.prototype._revertParamsChange=function(a){var b={p:a.p,len:a.len};return a.paramsi!=null&&(b.paramsd=a.paramsi),a.paramsd!=null&&(b.paramsi=a.paramsd),b},a.prototype._transformParamsChangeAgainstParamsChange=function(a,b,c,d,e,f,g,h){var i,j,k,m;return b.p>=c.p+c.len||b.p+b.len<=c.p||e!==g?(a.push(l(b)),a):(b.p<c.p&&(m=l(b),m.len=c.p-b.p,a.push(m)),d==="left"&&f!==h&&(j=Math.min(c.p+c.len,b.p+b.len),k=Math.max(b.p,c.p),i=this._revertParamsChange(c),m=l(b),m.p=i.p=k,m.len=i.len=j-k,a.push(i),a.push(m)),b.p+b.len>c.p+c.len&&(m=l(b),m.p=c.p+c.len,m.len=b.p+b.len-(c.p+c.len),a.push(m)),a)},a.prototype._transformParamsiAgainstParamsi=function(a,b,c,d){var e=this._getFirstParam(b.paramsi),f=e[0],g=e[1],h=this._getFirstParam(c.paramsi),i=h[0],j=h[1];return this._transformParamsChangeAgainstParamsChange(a,b,c,d,f,g,i,j)},a.prototype._transformParamsdAgainstParamsd=function(a,b,c,d){var e=this._getFirstParam(b.paramsd),f=e[0],g=e[1],h=this._getFirstParam(c.paramsd),i=h[0],j=h[1];return this._transformParamsChangeAgainstParamsChange(a,b,c,d,f,g,i,j)},a.prototype._getOpType=function(a){if(a.ti!=null)return"Ti";if(a.td!=null)return"Td";if(a.paramsi!=null)return"Paramsi";if(a.paramsd!=null)return"Paramsd"},a.prototype._getTransformFunction=function(a,b){var c="_transform"+this._getOpType(a)+"Against"+this._getOpType(b);return this[c]},a.prototype.name="text-formatted",a.prototype.create=function(){return[]},a.prototype.apply=function(a,b){var c,d,e;a=l(a);for(d=0,e=b.length;d<e;d++)c=b[d],a=this.applyOp(a,c);return a},a.prototype.applyOp=function(a,b){if(b.ti!=null)return this._applyTextInsert(a,b);if(b.td!=null)return this._applyTextDelete(a,b);if(b.paramsi!=null)return this._applyParamsInsert(a,b);if(b.paramsd!=null)return this._applyParamsDelete(a,b);throw new Error("Unknown operation applied: "+JSON.stringify(b))},a.prototype.transformOp=function(a,b,c,d){var e=this._getTransformFunction(b,c);return e(a,b,c,d)},a.prototype.compose=function(a,b){var c,d=[];return[].splice.apply(d,[0,0].concat(a)),a,[].splice.apply(d,[c=d.length,d.length-c].concat(b)),b,d},a.prototype.isFormattedTextOperation=function(a){return a.td!=null||a.ti!=null||a.paramsd!=null||a.paramsi!=null},a.prototype._invertOp=function(a){var b={};return b.p=a.p,a.params!=null&&(b.params=l(a.params)),a.td!=null&&(b.ti=l(a.td)),a.ti!=null&&(b.td=l(a.ti)),a.paramsd!=null&&(b.paramsi=l(a.paramsd)),a.paramsi!=null&&(b.paramsd=l(a.paramsi)),a.len!=null&&(b.len=l(a.len)),b},a.prototype.invert=function(a){var b,c=function(){var c,d,e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(this._invertOp(b));return e}.call(this);return c.reverse(),c},a}(),n=new d,i=function(){},m.types||(m.types={}),m._bt(n,n.transformOp,i,function(a,b){return a.push(b)}),m.types.ftext=n,l=function(a){return JSON.parse(JSON.stringify(a))},r=m.types.json,c=m.types.ftext,f=function(){function a(){this.transformOp=z(this.transformOp,this)}return a.prototype.name="volna",a.prototype.create=function(){return{content:c.create()}},a.prototype.apply=function(a,b){var c,d,e;try{a=l(a)}catch(f){throw console.warn("Got unclonable snapshot when applying 'volna' ops:",a),f}for(d=0,e=b.length;d<e;d++)c=b[d],a=this.applyOp(a,c);return a},a.prototype.applyOp=function(a,b){return c.isFormattedTextOperation(b)?a.content=c.applyOp(a.content,b):a=r.apply(a,[b]),a},a.prototype.transformOp=function(a,b,d,e){var f,g,h=c.isFormattedTextOperation(b),i=c.isFormattedTextOperation(d);if(h&&i)return c.transformOp(a,b,d,e);if(!h&&!i)return[].splice.apply(a,[f=a.length,9e9].concat(g=r.transform([b],[d],e))),g,a;try{a.push(l(b))}catch(j){throw console.warn("Got unclonable operation when transforming 'volna' ops:",b),j}return a},a.prototype.compose=function(a,b){return r.compose(a,b)},a}(),x=new f,i=function(){},m.types||(m.types={}),m._bt(x,x.transformOp,i,function(a,b){return a.push(b)}),m.types.volna=x,b=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p=this;this.name=b,this.version=c,this.type=d,this.snapshot=e;if(this.type.compose==null)throw new Error("Handling types without compose() defined is not currently implemented");g=null,f=[],k=null,j=[],l={},n=this.type.transformX||function(a,b){var c=p.type.transform(a,b,"left"),d=p.type.transform(b,a,"right");return[c,d]},i=function(a,b,c){var d=p.snapshot;p.snapshot=p.type.apply(p.snapshot,a),p.emit("change",a,d);if(b)return p.emit("remoteop",a,d,c)},this.flush=function(){if(g===null&&k!==null)return g=k,f=j,k=null,j=[],a.send({doc:p.name,op:g,v:p.version},function(a,b){var c,e,h,j,m,o,q,r=g;g=null;if(a){if(!d.invert)throw new Error("Op apply failed ("+b.error+") and the OT type does not define an invert function.");e=p.type.invert(r),k&&(q=n(k,e),k=q[0],e=q[1]),i(e,!0);for(h=0,m=f.length;h<m;h++)c=f[h],c(a)}else{if(b.v!==p.version)throw new Error("Invalid version from server");l[p.version]=r,p.version++;for(j=0,o=f.length;j<o;j++)c=f[j],c(null,r)}return p.flush()})},this._onOpReceived=function(a){var b,c,d,e;if(a.v<this.version)return;if(a.doc!==this.name)throw new Error("Expected docName '"+this.name+"' but got "+a.doc);if(a.v!==this.version)throw new Error("Expected version "+this.version+" but got "+a.v);return c=a.op,l[this.version]=c,b=c,g!==null&&(d=n(g,b),g=d[0],b=d[1]),k!==null&&(e=n(k,b),k=e[0],b=e[1]),this.version++,i(b,!0,a.meta)},this.submitOp=function(a,b){return this.type.normalize!=null&&(a=this.type.normalize(a)),this.snapshot=this.type.apply(this.snapshot,a),k!==null?k=this.type.compose(k,a):k=a,b&&j.push(b),this.emit("change",a),setTimeout(this.flush,0)},this.close=function(b){var c=this;return a.socket===null?typeof b=="function"?b():void 0:(a.send({doc:this.name,open:!1},function(){typeof b=="function"&&b(),c.emit("closed")}),this.emit("closing"))},this.hasUnsentOps=function(){return g!=null||k!=null};if(this.type.api){o=this.type.api;for(h in o)m=o[h],this[h]=m;typeof this._register=="function"&&this._register()}else this.provides={};return this},e.mixin(b),m.Doc=b,m.open=function(){var b={},c=function(c){var d,e,f;return f=window.location,c==null&&(c=""+f.protocol+"//"+f.hostname+"/sjs"),b[c]||(d=new a(c),d.numDocs=0,e=function(){return delete b[c]},d.on("disconnecting",e),d.on("connect failed",e),b[c]=d),b[c]};return function(a,b,d,e){var f;return typeof d=="function"&&(e=d,d=null),f=c(d),f.numDocs++,f.open(a,b,function(a,b){return a?(f.numDocs--,f.numDocs===0&&f.disconnect(),e(a)):(b.on("closed",function(){f.numDocs--;if(f.numDocs===0)return f.disconnect()}),e(null,b))}),f.on("connect failed")}}()})).call(this)