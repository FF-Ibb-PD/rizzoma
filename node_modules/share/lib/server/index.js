var Model, attach, browserChannel, connect, create, createDb, createModel, rest, socketio;

connect = require('connect');

Model = require('./model');

createDb = require('./db');

rest = require('./rest');

socketio = require('./socketio');

browserChannel = require('./browserchannel');

module.exports = create = function(options, model) {
  if (model == null) model = createModel(options);
  return attach(connect(), options, model);
};

create.createModel = createModel = function(options) {
  var db, dbOptions;
  dbOptions = options != null ? options.db : void 0;
  db = createDb(dbOptions);
  return new Model(db, options);
};

create.attach = attach = function(server, options, model) {
  var createClient;
  if (model == null) model = createModel(options);
  if (options == null) options = {};
  if (options.staticpath == null) options.staticpath = '/share';
  server.model = model;
  if (options.staticpath !== null) {
    server.use(options.staticpath, connect.static("" + __dirname + "/../../webclient"));
  }
  createClient = require('./auth')(model, options);
  if (options.rest !== null) server.use(rest(createClient, options.rest));
  if (options.socketio !== null) {
    socketio.attach(server, createClient, options.socketio || {});
  }
  if (options.browserChannel !== null) {
    if (options.browserChannel == null) options.browserChannel = {};
    options.browserChannel.server = server;
    server.use(browserChannel(createClient, options.browserChannel));
  }
  return server;
};
