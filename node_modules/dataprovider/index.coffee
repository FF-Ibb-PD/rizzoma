async = require('async')

###
Датапровайдер для nodeunit тестов.
В тесте пишем
dataprovider(test, testCases, testCode), где
    test - переменная передаваемая методу теста
    testCases - массив тесткейсов, например [[1, 'one'], [2, 'two']] - 2 кеса.
    testCode - функция, реализующая логику теста. Принимает параметры
        done - функцию, которую надо вызвать по завершении теста.
        аргументы из тесткейса
    Внимание! Тест не должен вызывать test.done() - это будет сделано датапровайдером.
    Пример
        testSomething: (test) ->
            testCode = (done, n, expected) ->
                test.equal(someFunctionForTesting(n), expected)
                done()
            dataprovider(test, [[1, 'one'], [2, 'two']], testCode)
###
module.exports = (testRunner, testCases, test) ->
    iterator = (testCase, callback) ->
        done = () ->
            callback(null, true)
        try
            test(done, testCase...)
        catch err
            text = require('util').inspect testCase
            testRunner.ok(false, "\nTest case \n#{text}\n failed with #{err.stack}")
            callback(err, null)
    async.forEachSeries(testCases, iterator, (err) ->
        testRunner.done()    
    )